<section class="row">
  <div class="col-sm-12 admin-inner-tab main-content form-horizontal" ng-form="$ctrl.activityForm">
    <div ng-if="$ctrl.workType === 'listings' || $ctrl.workType === 'cp-upload' || ($ctrl.workType === '' && $ctrl.productId) || $ctrl.workType === 'cp-status' || $ctrl.workType === 'cp-surveillance' || $ctrl.workType === 'cp-other'">
      <chpl-reports-listings product-id="$ctrl.productId"></chpl-reports-listings>
    </div>
    <div ng-if="$ctrl.workType === 'developers'">
      <chpl-reports-developers product-id="$ctrl.productId"></chpl-reports-developers>
    </div>
    <div class="row" ng-if="$ctrl.workType === 'prod'">
      <div class="col-sm-12">
        <h3>Product Activity</h3>
        <div>
          <label for="activity-start-product" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.product.startDate" name="activityStartProduct" id="activity-start-product" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-product" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.product.endDate" name="activityEndProduct" id="activity-end-product" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('product')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('product')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedProducts" st-safe-src="$ctrl.searchedProducts" class="table table-striped">
          <thead>
            <tr>
              <th class="search-header" st-sort="developer" st-skip-natural="true">Developer</th>
              <th class="search-header" st-sort="product" st-skip-natural="true">Product</th>
              <th class="search-header" st-sort="responsibleUser" st-skip-natural="true">Responsible User</th>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Activity Date</th>
            </tr>
            <tr>
              <th><input st-search="developer" placeholder="Filter Developer" class="input-sm form-control" type="search"></th>
              <th><input st-search="product" placeholder="Filter Product" class="input-sm form-control" type="search"></th>
              <th><input st-search="responsibleUser" placeholder="Filter Responsible User" class="input-sm form-control" type="search"></th>
              <th>&nbsp;</th>
              <th>&nbsp;</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <td colspan="5">
                <a type="button" class="btn btn-lg btn-ai-success"
                   ng-csv="$ctrl.displayedProducts" filename="Products_{{ $ctrl.filename }}"
                   csv-header="['Developer', 'Product', 'Resonsible User', 'Activity', 'Activity Date']"
                   csv-column-order="['developer', 'product', 'responsibleUser', 'action', 'friendlyActivityDate']">
                  <i class="fa fa-cloud-download"></i> Download
                </a>
              </td>
            </tr>
          </tfoot>
          <tbody>
            <tr ng-if="$ctrl.displayedProducts.length === 0">
              <td colspan="5">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedProducts" ng-if="$ctrl.displayedProducts.length > 0">
              <td>{{ activity.developer }}</td>
              <td>{{ activity.product }}</td>
              <td>{{ activity.responsibleUser }}</td>
              <td>
                <span ng-bind-html="activity.action"></span>
              </td>
              <td>{{ activity.date | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
        <h3>Version Activity</h3>
        <table st-table="$ctrl.displayedVersions" st-safe-src="$ctrl.searchedVersions" class="table table-striped">
          <thead>
            <tr>
              <th class="search-header" st-sort="product" st-skip-natural="true">Product</th>
              <th class="search-header" st-sort="name" st-skip-natural="true">Version</th>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedVersions.length === 0">
              <td colspan="4">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedVersions" ng-if="$ctrl.displayedVersions.length > 0">
              <td>{{ activity.product }}</td>
              <td>{{ activity.name }}</td>
              <td><span ng-bind-html="activity.action"></span></td>
              <td>{{ activity.date | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'acb'">
      <div class="col-sm-12">
        <h3>ONC-ACB Activity</h3>
        <div>
          <label for="activity-start-acb" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.acb.startDate" name="activityStartACB" id="activity-start-acb" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-acb" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.acb.endDate" name="activityEndACB" id="activity-end-acb" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('acb')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('acb')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedACBs" st-safe-src="$ctrl.searchedACBs" class="table table-striped">
          <thead>
            <tr>
              <th class="search-header" st-sort="name" st-skip-natural="true">ONC-ACB</th>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedACBs.length === 0">
              <td colspan="3">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedACBs" ng-if="$ctrl.displayedACBs.length > 0">
              <td>{{ activity.name }}</td>
              <td><span ng-bind-html="activity.action"></span></td>
              <td>{{ activity.date | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'atl'">
      <div class="col-sm-12">
        <h3>ONC-ATL Activity</h3>
        <div>
          <label for="activity-start-atl" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.atl.startDate" name="activityStartATL" id="activity-start-atl" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-atl" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.atl.endDate" name="activityEndATL" id="activity-end-atl" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('atl')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('atl')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedATLs" st-safe-src="$ctrl.searchedATLs" class="table table-striped">
          <thead>
            <tr>
              <th class="search-header" st-sort="name" st-skip-natural="true">ONC-ATL</th>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedATLs.length === 0">
              <td colspan="3">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedATLs" ng-if="$ctrl.displayedATLs.length > 0">
              <td>{{ activity.name }}</td>
              <td><span ng-bind-html="activity.action"></span></td>
              <td>{{ activity.date | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'announcement'">
      <div class="col-sm-12">
        <h3>Announcement Activity</h3>
        <div>
          <label for="activity-start-announcement" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.announcement.startDate" name="activityStartAnnouncement" id="activity-start-announcement" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-announcement" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.announcement.endDate" name="activityEndAnnouncement" id="activity-end-announcement" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('announcement')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('announcement')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedAnnouncements" st-safe-src="$ctrl.searchedAnnouncements" class="table table-striped">
          <thead>
            <tr>
              <th class="search-header" st-sort="name" st-skip-natural="true">Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedAnnouncements.length === 0">
              <td colspan="2">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedAnnouncements" ng-if="$ctrl.displayedAnnouncements.length > 0">
              <td>{{ activity.description }}</td>
              <td>{{ activity.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'users'">
      <div class="col-sm-12">
        <h3>User Activity</h3>
        <div>
          <label for="activity-start-user-activity" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.userActivity.startDate" name="activityStartUserActivity" id="activity-start-user-activity" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-user-activity" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.userActivity.endDate" name="activityEndUserActivity" id="activity-end-user-activity" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('userActivity')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('userActivity')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedUsers" st-safe-src="$ctrl.searchedUsers" class="table table-striped">
          <thead>
            <tr>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedUsers.length === 0">
              <td colspan="2">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedUsers" ng-if="$ctrl.displayedUsers.length > 0">
              <td><span ng-bind-html="activity.description"></span></td>
              <td>{{ activity.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
        <h3>User Actions</h3>
        <table st-table="$ctrl.displayedUserActivities" st-safe-src="$ctrl.searchedUserActivities" class="table">
          <thead>
            <tr>
              <th class="search-header" st-sort="user.fullName" st-skip-natural="true" st-sort-default>User</th>
              <th scope="col">Action</th>
              <th scope="col">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedUserActivities.length === 0">
              <td colspan="3">No activity found</td>
            </tr>
            <tr ng-repeat-start="activity in $ctrl.displayedUserActivities" ng-if="$ctrl.displayedUserActivities.length > 0">
              <td rowspan="{{ activity.events.length }}">{{ activity.user.fullName }}<br />{{ activity.user.email }}</td>
              <td>{{ activity.events[0].description }}</td>
              <td>{{ activity.events[0].activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
            <tr ng-repeat="action in activity.events" ng-if="!$first && $ctrl.displayedUserActivities.length > 0" ng-repeat-end>
              <td>{{ action.description }}</td>
              <td>{{ action.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'api_key_management'">
      <div class="col-sm-12">
        <h3>API Key Management Activity</h3>
        <div>
          <label for="activity-start-api-key" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.api_key.startDate" name="activityStartAPIKey" id="activity-start-api-key" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-api-key" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.api_key.endDate" name="activityEndAPIKey" id="activity-end-api-key" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('api_key')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('api_key')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedApiActivity" st-safe-src="$ctrl.searchedApiActivity" class="table table-striped">
          <thead>
            <tr>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedApiActivity.length === 0">
              <td colspan="2">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedApiActivity" ng-if="$ctrl.displayedApiActivity.length > 0">
              <td><span ng-bind-html="activity.description"></span></td>
              <td>{{ activity.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'api_key_usage'">
      <div class="col-sm-12">
        <h3>API Key Usage</h3>
        <div class="form-horizontal">
          <div>
            <label for="api-key-start-date" class="col-sm-2 control-label">Start Date</label>
            <div class="col-sm-3">
              <input type="date" class="form-control" ng-model="$ctrl.apiKey.startDate" name="apiKeyStartDate" id="api-key-start-date">
            </div>
            <label for="api-key-end-date" class="col-sm-2 control-label">End Date</label>
            <div class="col-sm-3">
              <input type="date" class="form-control" ng-model="$ctrl.apiKey.endDate" name="apiKeyEndDate" id="api-key-end-date">
            </div>
            <div class="col-sm-2">
              <button class="btn btn-primary" ng-click="$ctrl.refreshApiKeyUsage()">Search <i class="fa fa-search"></i></button>
            </div>
          </div>
          <div>
            <label for="api-key-date-ascending" class="col-sm-2 control-label">Oldest first</label>
            <div class="col-sm-2">
              <input type="checkbox" ng-model="$ctrl.apiKey.dateAscending" name="apiKeyDateAscending" id="api-key-date-ascending" ng-change="$ctrl.refreshApiKeyUsage()">
            </div>
            <label for="api-key-filter" class="col-sm-3 control-label">Show <a ng-click="$ctrl.apiKey.showOnly = !$ctrl.apiKey.showOnly; $ctrl.refreshApiKeyUsage()">{{ $ctrl.apiKey.showOnly ? 'only' : 'all but'}}</a> usage by API-Key</label>
            <div class="col-sm-5">
              <select class="form-control" ng-model="$ctrl.apiKey.filter" name="apiKeyFilter" id="api-key-filter" ng-change="$ctrl.refreshApiKeyUsage()"
                      ng-options="key.key as (key.name + ' (' + key.email + ')') for key in $ctrl.apiKeys | orderBy:'name' track by key.key">
                <option value=""></option>
              </select>
            </div>
          </div>
          <div class="col-sm-12"><a href ng-click="$ctrl.clearApiKeyFilter(); $ctrl.refreshApiKeyUsage();">Clear all filters</a></div>
        </div>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>API Key</th>
              <th scope="col">Email</th>
              <th scope="col">Name</th>
              <th scope="col">API Call Path</th>
              <th scope="col">Date</th>
            </tr>
          </thead>
          <tfoot>
            <td colspan="5" class="text-center">
              <pager ng-model="$ctrl.apiKey.visiblePage" ng-change="$ctrl.refreshApiKeyUsage()" class="pagination-sm" total-items="20000"></pager>
            </td>
          </tfoot>
          <tbody>
            <tr ng-if="$ctrl.searchedApi.length === 0">
              <td colspan="5">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.searchedApi" ng-if="$ctrl.searchedApi.length > 0">
              <td>{{ activity.apiKey }}</td>
              <td>{{ activity.email }}</td>
              <td>{{ activity.name }}</td>
              <td>{{ activity.apiCallPath }}</td>
              <td>{{ activity.creationDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
