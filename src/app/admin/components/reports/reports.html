<section class="row">
  <div class="col-sm-12 admin-inner-tab main-content form-horizontal" ng-form="$ctrl.activityForm">
    <div ng-if="$ctrl.workType === 'listings' || $ctrl.workType === 'cp-upload' || ($ctrl.workType === '' && $ctrl.productId) || $ctrl.workType === 'cp-status' || $ctrl.workType === 'cp-surveillance' || $ctrl.workType === 'cp-other'">
      <chpl-reports-listings product-id="$ctrl.productId"></chpl-reports-listings>
    </div>
    <div ng-if="$ctrl.workType === 'developers'">
      <chpl-reports-developers></chpl-reports-developers>
    </div>
    <div ng-if="$ctrl.workType === 'prod'">
      <chpl-reports-products></chpl-reports-products>
    </div>
    <div ng-if="$ctrl.workType === 'versions'">
      <chpl-reports-versions></chpl-reports-versions>
    </div>
    <div ng-if="$ctrl.workType === 'acb'">
      <chpl-reports-acbs></chpl-reports-acbs>
    </div>
    <div ng-if="$ctrl.workType === 'atl'">
      <chpl-reports-atls></chpl-reports-atls>
    </div>
    <div ng-if="$ctrl.workType === 'announcement'">
      <chpl-reports-announcements></chpl-reports-announcements>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'users'">
      <div class="col-sm-12">
        <h3>User Activity</h3>
        <div>
          <label for="activity-start-user-activity" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.userActivity.startDate" name="activityStartUserActivity" id="activity-start-user-activity" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-user-activity" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.userActivity.endDate" name="activityEndUserActivity" id="activity-end-user-activity" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('userActivity')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('userActivity')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedUsers" st-safe-src="$ctrl.searchedUsers" class="table table-striped">
          <thead>
            <tr>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedUsers.length === 0">
              <td colspan="2">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedUsers" ng-if="$ctrl.displayedUsers.length > 0">
              <td><span ng-bind-html="activity.description"></span></td>
              <td>{{ activity.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
        <h3>User Actions</h3>
        <table st-table="$ctrl.displayedUserActivities" st-safe-src="$ctrl.searchedUserActivities" class="table">
          <thead>
            <tr>
              <th class="search-header" st-sort="user.fullName" st-skip-natural="true" st-sort-default>User</th>
              <th scope="col">Action</th>
              <th scope="col">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedUserActivities.length === 0">
              <td colspan="3">No activity found</td>
            </tr>
            <tr ng-repeat-start="activity in $ctrl.displayedUserActivities" ng-if="$ctrl.displayedUserActivities.length > 0">
              <td rowspan="{{ activity.events.length }}">{{ activity.user.fullName }}<br />{{ activity.user.email }}</td>
              <td>{{ activity.events[0].description }}</td>
              <td>{{ activity.events[0].activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
            <tr ng-repeat="action in activity.events" ng-if="!$first && $ctrl.displayedUserActivities.length > 0" ng-repeat-end>
              <td>{{ action.description }}</td>
              <td>{{ action.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'api_key_management'">
      <div class="col-sm-12">
        <h3>API Key Management Activity</h3>
        <div>
          <label for="activity-start-api-key" class="col-sm-2 control-label">Start Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.api_key.startDate" name="activityStartAPIKey" id="activity-start-api-key" placeholder="yyyy-MM-dd">
          </div>
          <label for="activity-end-api-key" class="col-sm-2 control-label">End Date</label>
          <div class="col-sm-3">
            <input type="date" class="form-control" ng-model="$ctrl.activityRange.api_key.endDate" name="activityEndAPIKey" id="activity-end-api-key" placeholder="yyyy-MM-dd">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary" ng-click="$ctrl.refreshActivity()" ng-disabled="!$ctrl.validDates('api_key')">Search <i class="fa fa-search"></i></button>
          </div>
          <div class="col-sm-12 text-danger" ng-if="!$ctrl.validDates('api_key')">Start date must be before end date, and no more than {{ $ctrl.activityRange.range }} days apart</div>
        </div>
        <table st-table="$ctrl.displayedApiActivity" st-safe-src="$ctrl.searchedApiActivity" class="table table-striped">
          <thead>
            <tr>
              <th>Activity</th>
              <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Date</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-if="$ctrl.displayedApiActivity.length === 0">
              <td colspan="2">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.displayedApiActivity" ng-if="$ctrl.displayedApiActivity.length > 0">
              <td><span ng-bind-html="activity.description"></span></td>
              <td>{{ activity.activityDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row" ng-if="$ctrl.workType === 'api_key_usage'">
      <div class="col-sm-12">
        <h3>API Key Usage</h3>
        <div class="form-horizontal">
          <div>
            <label for="api-key-start-date" class="col-sm-2 control-label">Start Date</label>
            <div class="col-sm-3">
              <input type="date" class="form-control" ng-model="$ctrl.apiKey.startDate" name="apiKeyStartDate" id="api-key-start-date">
            </div>
            <label for="api-key-end-date" class="col-sm-2 control-label">End Date</label>
            <div class="col-sm-3">
              <input type="date" class="form-control" ng-model="$ctrl.apiKey.endDate" name="apiKeyEndDate" id="api-key-end-date">
            </div>
            <div class="col-sm-2">
              <button class="btn btn-primary" ng-click="$ctrl.refreshApiKeyUsage()">Search <i class="fa fa-search"></i></button>
            </div>
          </div>
          <div>
            <label for="api-key-date-ascending" class="col-sm-2 control-label">Oldest first</label>
            <div class="col-sm-2">
              <input type="checkbox" ng-model="$ctrl.apiKey.dateAscending" name="apiKeyDateAscending" id="api-key-date-ascending" ng-change="$ctrl.refreshApiKeyUsage()">
            </div>
            <label for="api-key-filter" class="col-sm-3 control-label">Show <a ng-click="$ctrl.apiKey.showOnly = !$ctrl.apiKey.showOnly; $ctrl.refreshApiKeyUsage()">{{ $ctrl.apiKey.showOnly ? 'only' : 'all but'}}</a> usage by API-Key</label>
            <div class="col-sm-5">
              <select class="form-control" ng-model="$ctrl.apiKey.filter" name="apiKeyFilter" id="api-key-filter" ng-change="$ctrl.refreshApiKeyUsage()"
                      ng-options="key.key as (key.name + ' (' + key.email + ')') for key in $ctrl.apiKeys | orderBy:'name' track by key.key">
                <option value=""></option>
              </select>
            </div>
          </div>
          <div class="col-sm-12"><a href ng-click="$ctrl.clearApiKeyFilter(); $ctrl.refreshApiKeyUsage();">Clear all filters</a></div>
        </div>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>API Key</th>
              <th scope="col">Email</th>
              <th scope="col">Name</th>
              <th scope="col">API Call Path</th>
              <th scope="col">Date</th>
            </tr>
          </thead>
          <tfoot>
            <td colspan="5" class="text-center">
              <pager ng-model="$ctrl.apiKey.visiblePage" ng-change="$ctrl.refreshApiKeyUsage()" class="pagination-sm" total-items="20000"></pager>
            </td>
          </tfoot>
          <tbody>
            <tr ng-if="$ctrl.searchedApi.length === 0">
              <td colspan="5">No activity found</td>
            </tr>
            <tr ng-repeat="activity in $ctrl.searchedApi" ng-if="$ctrl.searchedApi.length > 0">
              <td>{{ activity.apiKey }}</td>
              <td>{{ activity.email }}</td>
              <td>{{ activity.name }}</td>
              <td>{{ activity.apiCallPath }}</td>
              <td>{{ activity.creationDate | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
